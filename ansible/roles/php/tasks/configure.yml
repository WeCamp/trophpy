---
- name: Modify PHP max upload size
  lineinfile: dest=/etc/php/7.1/fpm/php.ini
              regexp='upload_max_filesize'
              line='upload_max_filesize = 60M'
  notify: restart php7.1-fpm

- name: Modify PHP max post size
  lineinfile: dest=/etc/php/7.1/fpm/php.ini
              regexp='post_max_size'
              line='post_max_size = 60M'
  notify: restart php7.1-fpm

- name: ensure timezone is set in fpm php.ini
  lineinfile: dest=/etc/php/7.1/fpm/php.ini
              regexp='date.timezone ='
              line='date.timezone = {{ server.timezone }}'
  notify: restart php7.1-fpm

- name: ensure session.cache_limiter is set to blank
  lineinfile: dest=/etc/php/7.1/fpm/php.ini
              regexp='session.cache_limiter ='
              line='session.cache_limiter = \'\''
  notify: restart php7.1-fpm

- name: enabling opcache
  lineinfile: dest=/etc/php/7.1/fpm/php.ini
              regexp=';?opcache.enable=\d'
              line='opcache.enable=1'
  notify: restart php7.1-fpm

- name: configure fpm max_children
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm.max_children = \d'
              line='pm.max_children = {{ phpfpm.max_children }}'
  when: phpfpm.max_children is defined
  notify: restart php7.1-fpm

- name: configure fpm start_servers
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm.start_servers = \d'
              line='pm.start_servers = {{ phpfpm.start_servers }}'
  when: phpfpm.start_servers is defined
  notify: restart php7.1-fpm

- name: configure fpm min_spare_servers
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm.min_spare_servers = \d'
              line='pm.min_spare_servers = {{ phpfpm.min_spare_servers }}'
  when: phpfpm.min_spare_servers is defined
  notify: restart php7.1-fpm

- name: configure fpm max_spare_servers
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm.max_spare_servers = \d'
              line='pm.max_spare_servers = {{ phpfpm.max_spare_servers }}'
  when: phpfpm.max_spare_servers is defined
  notify: restart php7.1-fpm

- name: configure fpm max_requests
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm.max_requests = \d'
              line='pm.max_requests = {{ phpfpm.max_requests }}'
  when: phpfpm.max_requests is defined
  notify: restart php7.1-fpm

- name: configure fpm process_idle_timeout
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm.process_idle_timeout = \d'
              line='pm.process_idle_timeout = {{ phpfpm.process_idle_timeout }}'
  when: phpfpm.process_idle_timeout is defined
  notify: restart php7.1-fpm

- name: configure fpm mode
  lineinfile: dest=/etc/php/7.1/fpm/pool.d/www.conf
              regexp=';?pm = \w'
              line='pm = {{ phpfpm.pm }}'
  notify: restart php7.1-fpm

- name: Enable FPM status path
  lineinfile: "dest=/etc/php/7.1/fpm/pool.d/www.conf state=present regexp='^;?pm.status_path' line='pm.status_path = /fpm-status'"
  notify: restart php7.1-fpm

- name: Enable FPM ping path
  lineinfile: "dest=/etc/php/7.1/fpm/pool.d/www.conf state=present regexp='^;?ping.path' line='ping.path = /fpm-ping'"
  notify: restart php7.1-fpm

- name: Set www.conf as managed by Ansible
  lineinfile:
    dest=/etc/php/7.1/fpm/pool.d/www.conf
    insertbefore=BOF
    line='; Ansible managed'
    state=present

- name: Set php.ini as managed by Ansible
  lineinfile:
    dest=/etc/php/7.1/fpm/php.ini
    insertbefore=BOF
    line='; Ansible managed'
    state=present
